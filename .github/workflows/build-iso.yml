name: Build YmY OS ISO

# Manuel tetikleme iÃ§in workflow_dispatch kullanÄ±yoruz
# Oto build ve oto release yok
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 43-beta-1)'
        required: true
        default: '43-beta-1'
      create_release:
        description: 'Create GitHub Release?'
        required: true
        type: boolean
        default: false

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: fedora:43
      options: --privileged
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          dnf install -y lorax anaconda createrepo_c git wget curl
          dnf install -y syslinux grub2-efi-x64 grub2-efi-x64-modules
          dnf install -y grub2-tools-extra dosfstools xorriso genisoimage
      
      - name: Prepare build environment
        run: |
          mkdir -p /build/ymy-os
          mkdir -p /build/iso
          mkdir -p /build/result
      
      - name: Copy configuration files
        run: |
          cp -r kickstart /build/ymy-os/
          cp -r branding /build/ymy-os/
          cp -r config /build/ymy-os/
      
      - name: Download Fedora base packages
        run: |
          cd /build
          # Fedora 43 Everything repository kullanÄ±lÄ±yor
          mkdir -p repos/fedora
          createrepo_c repos/fedora
      
      - name: Build ISO with Lorax
        run: |
          cd /build
          lorax \
            --product="YmY OS" \
            --version="43" \
            --release="Beta" \
            --source=https://download.fedoraproject.org/pub/fedora/linux/releases/43/Everything/x86_64/os/ \
            --source=https://download.fedoraproject.org/pub/fedora/linux/updates/43/Everything/x86_64/ \
            --variant="Workstation" \
            --bugurl="https://github.com/yusufbaran11/ymy-os/issues" \
            --nomacboot \
            --buildarch=x86_64 \
            --volid="YmY-OS-43-Beta" \
            /build/result
      
      - name: Customize ISO
        run: |
          cd /build/result
          # Logo dosyalarÄ±nÄ± ekle
          mkdir -p images/branding
          cp /build/ymy-os/branding/*.png images/branding/
          
          # Kickstart dosyasÄ±nÄ± ekle
          cp /build/ymy-os/kickstart/ymy-os.ks isolinux/ks.cfg
      
      - name: Generate ISO file
        run: |
          cd /build/result
          mkisofs \
            -o /build/YmY-OS-${{ github.event.inputs.version }}-x86_64.iso \
            -b isolinux/isolinux.bin \
            -c isolinux/boot.cat \
            -no-emul-boot \
            -boot-load-size 4 \
            -boot-info-table \
            -R -J -v -T \
            -V "YmY-OS-43-Beta" \
            .
      
      - name: Generate checksums
        run: |
          cd /build
          sha256sum YmY-OS-${{ github.event.inputs.version }}-x86_64.iso > YmY-OS-${{ github.event.inputs.version }}-x86_64.iso.sha256sum
          md5sum YmY-OS-${{ github.event.inputs.version }}-x86_64.iso > YmY-OS-${{ github.event.inputs.version }}-x86_64.iso.md5sum
      
      - name: Upload ISO artifact
        uses: actions/upload-artifact@v4
        with:
          name: ymy-os-iso-${{ github.event.inputs.version }}
          path: |
            /build/YmY-OS-${{ github.event.inputs.version }}-x86_64.iso
            /build/YmY-OS-${{ github.event.inputs.version }}-x86_64.iso.sha256sum
            /build/YmY-OS-${{ github.event.inputs.version }}-x86_64.iso.md5sum
          retention-days: 30
      
      - name: Create GitHub Release
        if: ${{ github.event.inputs.create_release == 'true' }}
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ github.event.inputs.version }}
          name: YmY OS ${{ github.event.inputs.version }}
          body: |
            # YmY OS ${{ github.event.inputs.version }}
            
            ## ğŸ“¦ Ä°ndirme
            
            ISO dosyasÄ±nÄ± indirip bir USB belleÄŸe yazarak YmY OS'u deneyebilirsiniz.
            
            ## âœ¨ Ã–zellikler
            
            - Fedora 43 tabanlÄ±
            - GNOME masaÃ¼stÃ¼ ortamÄ±
            - TÃ¼rkÃ§e dil desteÄŸi
            - Ã–nceden yÃ¼klenmiÅŸ uygulamalar
            - Linux'a yeni baÅŸlayanlar iÃ§in optimize edilmiÅŸ
            
            ## ğŸ“ Kurulum
            
            1. ISO dosyasÄ±nÄ± indirin
            2. Rufus, Etcher veya Fedora Media Writer ile USB'ye yazÄ±n
            3. BilgisayarÄ±nÄ±zÄ± USB'den baÅŸlatÄ±n
            4. Kurulum sihirbazÄ±nÄ± takip edin
            
            ## ğŸ” DoÄŸrulama
            
            Ä°ndirdiÄŸiniz dosyanÄ±n bÃ¼tÃ¼nlÃ¼ÄŸÃ¼nÃ¼ kontrol etmek iÃ§in SHA256 checksum dosyasÄ±nÄ± kullanÄ±n.
            
            ---
            
            **YmY Studios** ile geliÅŸtirilmiÅŸtir â¤ï¸
          files: |
            /build/YmY-OS-${{ github.event.inputs.version }}-x86_64.iso
            /build/YmY-OS-${{ github.event.inputs.version }}-x86_64.iso.sha256sum
            /build/YmY-OS-${{ github.event.inputs.version }}-x86_64.iso.md5sum
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
